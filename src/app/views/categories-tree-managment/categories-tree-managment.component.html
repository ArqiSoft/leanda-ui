<dr-splash-notification></dr-splash-notification>
<div class="container-fluid">
  <h3>Categories</h3>
  <div class="row">
    <div [ngClass]="{ 'col-8': !isTreeEmpty(), 'col-6': isTreeEmpty() }">
      <div class="card" [ngSwitch]="isTreeEmpty() && hasCategories()">
        <ng-container *ngSwitchCase="true">
          <ng-container *ngTemplateOutlet="emptyTree"></ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="false">
          <ng-container *ngTemplateOutlet="tree"></ng-container>
        </ng-container>
        <ng-container *ngSwitchDefault>
          <mat-spinner></mat-spinner>
        </ng-container>
      </div>
    </div>
    <div [ngClass]="{ 'col-4': !isTreeEmpty(), 'col-6': isTreeEmpty() }">
      <div *ngIf="!isTreeEmpty()" class="card h-50">
        <h4>Category info</h4>
        <ul>
          <li>Created by: {{ treeInfo?.createdBy }}</li>
          <li>Created date: {{ treeInfo?.createdDateTime | date: 'short' }}</li>
          <li>Updated by: {{ treeInfo?.updatedBy }}</li>
          <li>Updated date: {{ treeInfo?.updatedDateTime | date: 'short' }}</li>
        </ul>
      </div>
      <div class="card" [ngClass]="{ 'h-49 mt-2': !isTreeEmpty() }">
        <h4>Hints & Rules</h4>
        <ul>
          <li>Tree can consisnt of multiple <strong>Nodes</strong></li>
          <li>Tree node can be flat or nested</li>
          <li>Flat node has only one property - <strong>Title</strong></li>
          <li>
            Nested node may have two properties - <strong>Title</strong> and
            <strong>Children</strong>
          </li>
          <li>Children nodes can be flat or nested</li>
          <li>Node title may not exceed <strong>30</strong> symbols</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<ng-template #emptyTree>
  <small class="text-info font-weight-bold">
    <p>
      There are no categories assign to the user.
    </p>
    <p>
      Please new node name.
    </p>
  </small>
  <mat-form-field>
    <input matInput type="text" #initNodeTitle placeholder="Title..." [(ngModel)]="initNodeTitle.value"
      maxlength="30" />
    <button matSuffix mat-icon-button aria-label="Clear" [disabled]="initNodeTitle.value === ''"
      (click)="initNodeTitle.value = ''">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>
  <button mat-stroked-button class="btn btn-primary text-white" (click)="createCategory(initNodeTitle.value)">
    Save
  </button>
</ng-template>

<ng-template #tree>
  <button id="addMainNode" mat-icon-button (click)="addNewMainNode()">
    <mat-icon>add</mat-icon>
  </button>
  <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
    <!-- 
      * Existing node with title and with/without children
     -->
    <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
      <!-- Collapse button -->
      <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'toggle ' + node.title"
        [disabled]="!hasChild(null, node)">
        <mat-icon class="mat-icon-rtl-mirror">
          {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
        </mat-icon>
      </button>
      <!-- Title and buttons -->
      <ng-container *ngTemplateOutlet="nodeTemp; context: { node: node }"></ng-container>
    </mat-tree-node>

    <!-- 
      * New node without title and without children
     -->
    <mat-tree-node *matTreeNodeDef="let node; when: hasNoContent" matTreeNodePadding>
      <!-- Collapse button -->
      <!-- <button mat-icon-button disabled></button> -->
      <mat-form-field class="pl-3">
        <input matInput type="text" #newNodeTitle placeholder="Title..." [(ngModel)]="newNodeTitle.value" />
        <button mat-button [disabled]="newNodeTitle.value === ''" matSuffix mat-icon-button aria-label="Clear"
          (click)="newNodeTitle.value = ''">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
      <button mat-stroked-button class="node-icon-button mx-0-1" [hidden]="treeHasOneMainNode() && getLevel(node) === 0"
        (click)="removeNode(node)">
        <mat-icon>remove</mat-icon>
      </button>
      <button mat-stroked-button class="mx-0-1" (click)="saveNode(node, newNodeTitle.value)">
        Save
      </button>
    </mat-tree-node>
  </mat-tree>
</ng-template>

<ng-template #nodeTemp let-node="node">
  <!-- Switch between templates of "edit" and "display" mode-->
  <ng-container [ngSwitch]="node.isEditEnabled">
    <!-- If Node name "edit" mode - toggled "ON" -->
    <ng-container *ngSwitchCase="true">
      <ng-container *ngTemplateOutlet="editNodeTemp; context: { node: node }"></ng-container>
    </ng-container>

    <!-- If Node name "display" mode - toggled "OFF" -->
    <ng-container *ngSwitchCase="false">
      <div class="pr-3">{{ node.title }}</div>
      <button mat-stroked-button class="node-icon-button mx-0-1" [color]="'primary'" (click)="addNewNode(node)">
        <mat-icon>add</mat-icon>
      </button>
      <button mat-stroked-button class="node-icon-button mx-0-1" [color]="'primary'" (click)="removeNode(node)"
        [disabled]="treeHasOneMainNode() && node.level === 0">
        <mat-icon>remove</mat-icon>
      </button>
    </ng-container>
  </ng-container>

  <!-- Toggles Node Edit Mode -->
  <button mat-stroked-button class="node-icon-button mx-0-1" (click)="node.isEditEnabled = !node.isEditEnabled">
    <mat-icon class="icon-large align-bottom" [color]="'primary'">edit</mat-icon>
  </button>
</ng-template>

<!-- Edit node template -->
<ng-template #editNodeTemp let-node="node">
  <mat-form-field>
    <input #newTitle matInput type="text" placeholder="Title..." [(ngModel)]="newTitle.value" />
    <button matSuffix mat-icon-button aria-label="Clear" [disabled]="newTitle.value === ''"
      (click)="newTitle.value = ''">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>
  <button mat-stroked-button class="flex-last mx-1" (click)="saveNode(node, newTitle.value)">
    Save
  </button>
</ng-template>